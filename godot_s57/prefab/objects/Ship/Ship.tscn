[gd_scene load_steps=6 format=3 uid="uid://jywn1e0tmbbu"]

[ext_resource type="PackedScene" uid="uid://chlm3a147a37f" path="res://prefab/objects/Ship/Simple Battleship.glb" id="1_0pr7t"]
[ext_resource type="Script" uid="uid://depyr4nvddnc" path="res://Scripts/WORLD_sc/SimpleBuoyancy.gd" id="1_h5k0y"]
[ext_resource type="Script" uid="uid://mtpqlvypkyjn" path="res://Scripts/WORLD_sc/ShipController.gd" id="1_xyd1p"]

[sub_resource type="BoxShape3D" id="BoxShape3D_h5k0y"]
size = Vector3(14.2374, 2.54111, 2.77699)

[sub_resource type="GDScript" id="GDScript_xyd1p"]
resource_name = "RosMan_2"
script/source = "extends Node3D # Veya RigidBody3D, mevcut yapın neyse

@export var socket_url: String = \"ws://192.168.98.206:9090\"

# --- LIDAR 1: ENGEL TESPİTİ (YATAY) ---
@export_group(\"Navigasyon Lidar\")
@export var nav_lidar_node: Node3D # Editörden LidarHorizontal'ı buraya sürükle
@export var nav_range: float = 50.0
@export var nav_rays: int = 72 # Işın sayısı
@export var show_nav_debug: bool = true # Çizgileri görmek için

# --- LIDAR 2: DERİNLİK/TABAN (DİKEY) ---
@export_group(\"Derinlik Lidar\")
@export var depth_lidar_node: Node3D # Editörden LidarDepth'i buraya sürükle
@export var depth_range: float = 20.0
@export var depth_rays: int = 10 
@export var show_depth_debug: bool = true

var socket = WebSocketPeer.new()
var nav_raycasts: Array[RayCast3D] = []
var depth_raycasts: Array[RayCast3D] = []
var last_publish_time = 0.0

@onready var real_ship = get_parent()

func _ready():
	# ... (Bağlantı kodları aynı) ...
	socket.connect_to_url(socket_url)
	
	# İki Lidar'ı da kuruyoruz
	if nav_lidar_node:
		_setup_lidar(nav_lidar_node, nav_rays, nav_range, 360.0, nav_raycasts, Color.RED)
	if depth_lidar_node:
		_setup_lidar(depth_lidar_node, depth_rays, depth_range, 30.0, depth_raycasts, Color.BLUE) # 30 derece koni

func _setup_lidar(parent_node, count, dist, fov_angle, array_ref, color):
	for i in range(count):
		var ray = RayCast3D.new()
		parent_node.add_child(ray)
		
		# Açıyı ayarla
		var angle = 0.0
		if fov_angle >= 360:
			angle = i * (TAU / count) # Tam tur
		else:
			# Belirli bir açıda tarama (örn. aşağı doğru koni)
			angle = deg_to_rad(-fov_angle/2 + (i * fov_angle / (count-1)))
			
		# RayCast Yönü (Local Z eksenine göre)
		if parent_node == nav_lidar_node:
			ray.target_position = Vector3(dist, 0, 0).rotated(Vector3.UP, angle)
		else:
			ray.target_position = Vector3(0, -dist, 0).rotated(Vector3.RIGHT, angle)
			 
		ray.enabled = true
		# Debug için görünürlük
		ray.debug_shape_custom_color = color
		ray.debug_shape_thickness = 2
		array_ref.append(ray)

func _process(delta):
	# ... (Socket poll işlemleri aynı) ...
	
	# Debug Çizgilerini Canlı Tut (Godot Editörde: Debug -> Visible Collision Shapes AÇIK OLMALI)
	pass

func _publish_data():
	# ... (Odom kodları aynı) ...
	
	# --- SCAN 1: NAVIGASYON ---
	var nav_ranges = []
	for ray in nav_raycasts:
		if ray.is_colliding():
			nav_ranges.append(ray.global_position.distance_to(ray.get_collision_point()))
		else:
			nav_ranges.append(nav_range + 1.0) # Sonsuz
			
	# Bu mesajı /scan topic'ine gönderiyoruz
	var nav_msg = {
		\"op\": \"publish\",
		\"topic\": \"/scan\", # Navigasyon Lidar'ı standart /scan kullanır
		\"msg\": { 
			\"ranges\": nav_ranges, 
			\"angle_max\": 2*PI, \"angle_min\": 0.0, \"range_max\": nav_range 
			# (Header vs. detayları önceki koddaki gibi doldur)
		}
	}
	socket.send_text(JSON.stringify(nav_msg))

	# --- SCAN 2: DERİNLİK ---
	var depth_ranges = []
	for ray in depth_raycasts:
		if ray.is_colliding():
			depth_ranges.append(ray.global_position.distance_to(ray.get_collision_point()))
		else:
			depth_ranges.append(depth_range + 1.0)

	# Bunu farklı bir topic'e gönderelim
	var depth_msg = {
		\"op\": \"publish\",
		\"topic\": \"/depth_scan\", # Yeni Topic!
		\"msg\": { 
			\"ranges\": depth_ranges, 
			\"range_max\": depth_range 
			 # (Burası da LaserScan formatında olabilir veya Range array)
		}
	}
	socket.send_text(JSON.stringify(depth_msg))
"

[node name="Ship" type="RigidBody3D"]
transform = Transform3D(-4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 0, 0, 0)
mass = 50.0
script = ExtResource("1_h5k0y")

[node name="ShipController" type="RigidBody3D" parent="."]
collision_layer = 0
collision_mask = 0
freeze = true
script = ExtResource("1_xyd1p")

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.465193, 0.731617, -0.0815811)
shape = SubResource("BoxShape3D_h5k0y")
debug_color = Color(0.239846, 0.589756, 0, 0.419608)

[node name="Simple Battleship" parent="." instance=ExtResource("1_0pr7t")]
transform = Transform3D(3, 0, 0, 0, 3, 0, 0, 0, 3, 0, 1.8, 0)

[node name="ChaseCamera" type="Camera3D" parent="."]
transform = Transform3D(-4.37114e-08, -0.707107, 0.707107, 0, 0.707107, 0.707107, -1, 3.09086e-08, -3.09086e-08, 3.75056, 8.76067, -0.118086)
fov = 100.0
near = 0.1

[node name="RosManager" type="Node3D" parent="." node_paths=PackedStringArray("nav_lidar_node", "depth_lidar_node")]
script = SubResource("GDScript_xyd1p")
nav_lidar_node = NodePath("LidarHorizontal")
depth_lidar_node = NodePath("LidarDepth")

[node name="LidarDepth" type="Node3D" parent="RosManager"]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, -0.162156, 0)

[node name="LidarHorizontal" type="Node3D" parent="RosManager"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.60467, 2.22947, 2.01276e-07)
